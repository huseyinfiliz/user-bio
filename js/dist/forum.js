(()=>{var e={179:function(){(function(){var e=[].slice;String.prototype.autoLink=function(){var t,o,r,i,s,n;return s=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,0<(i=1<=arguments.length?e.call(arguments,0):[]).length?(r=i[0],o=function(){var e;for(t in e=[],r)n=r[t],"callback"!==t&&e.push(" "+t+"='"+n+"'");return e}().join(""),this.replace(s,(function(e,t,i){return""+t+(("function"==typeof r.callback?r.callback(i):void 0)||"<a href='"+i+"'"+o+">"+i+"</a>")}))):this.replace(s,"$1<a href='$2'>$2</a>")}}).call(this)}},t={};function o(r){flarum.reg._webpack_runtimes["fof-user-bio"]||=o;var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,o),s.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};(()=>{"use strict";o.r(r),o.d(r,{components:()=>w});const e=flarum.reg.get("core","forum/app");var t=o.n(e);const i=flarum.reg.get("core","common/extend");o(179);const s=flarum.reg.get("core","forum/components/UserCard");var n=o.n(s);const a=flarum.reg.get("core","common/models/User");var l=o.n(a);const c=flarum.reg.get("core","common/Model");var u=o.n(c);const d=flarum.reg.get("core","common/Component");var f=o.n(d);const h=flarum.reg.get("core","common/components/LoadingIndicator");var p=o.n(h);const b=flarum.reg.get("core","common/components/Button");var g=o.n(b);const v=flarum.reg.get("core","common/utils/classList");var x=o.n(v);const y=flarum.reg.get("core","common/utils/extractText");var B=o.n(y);class S extends(f()){oninit(e){super.oninit(e),this.editing=!1,this.loading=!1,this.textareaRows="5",this.bioMaxLength=t().forum.attribute("fof-user-bio.maxLength"),this.bioPlaceholder=t().session&&t().session.user&&t().session.user.id()===this.attrs.user.id()?t().translator.trans("fof-user-bio.forum.userbioPlaceholder"):t().translator.trans("fof-user-bio.forum.userbioPlaceholderOtherUser",{username:this.attrs.user.displayName()})}view(){const e=this.attrs.user,o=this.attrs.editable&&this.attrs.user.attribute("canEditBio");let r;if(this.editing){const o=this.tempBio,i=null!=o?o:e.bio(),s=e=>{const t=e.dom;t.value=i,void 0!==o&&(t.value=o,t.focus(),void 0!==this.tempSelector&&(t.selectionStart=this.tempSelector,t.selectionEnd=this.tempSelector,delete this.tempSelector))};r=m("form",{onsubmit:this.save.bind(this)},m("textarea",{className:"FormControl",placeholder:B()(this.bioPlaceholder),rows:this.textareaRows,maxlength:this.bioMaxLength,oncreate:s}),m("div",{className:"UserBio-actions"},m(g(),{className:"Button Button--primary",type:"submit"},t().translator.trans("fof-user-bio.forum.profile.save_button")),m(g(),{className:"Button",type:"reset",onclick:this.reset.bind(this)},t().translator.trans("fof-user-bio.forum.profile.cancel_button"))))}else{let i;if(this.loading)i=m("p",{className:"UserBio-placeholder"},m(p(),null));else{const t=e.bioHtml();t?i=m.trust(t):e.bio()?i=m.trust("<p>"+$("<div/>").text(e.bio()).html().replace(/\n/g,"<br>").autoLink({rel:"nofollow ugc",target:"_blank"})+"</p>"):o&&(i=m("p",{className:"UserBio-placeholder"},this.bioPlaceholder))}const s=t().forum.attribute("fof-user-bio.maxLines")||5;r=m("div",{className:"UserBio-content",onclick:o?this.edit.bind(this):()=>{},onkeydown:o?this.onkeydown.bind(this):()=>{},style:{"--bio-max-lines":s},role:o?"button":void 0,tabindex:o?"0":void 0,"aria-label":o?t().translator.trans("fof-user-bio.forum.profile.edit_bio_label"):void 0},i)}return m("div",{className:"UserBio "+x()({editable:o,editing:this.editing})},r)}onkeydown(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this.edit(e))}edit(e){if(e.ctrlKey||e.metaKey)return;e.preventDefault();const t=window.getSelection(),o=t.anchorOffset,r=t.anchorNode&&e.target.className.includes("UserBio")?t.anchorNode:e.target,i=this.countTextLengthBefore(r),s=e.currentTarget.scrollTop,n=i+o;this.textareaRows=getComputedStyle(e.currentTarget).getPropertyValue("--bio-max-lines")||"5",this.editing=!0,m.redraw.sync(),this.$("textarea").trigger("focus").prop("selectionStart",n).prop("selectionEnd",n).prop("scrollTop",s)}save(e){e.preventDefault();const t=this.$("textarea").val(),o=this.attrs.user,r=this.$("textarea").prop("selectionStart");this.isDirty()&&(this.loading=!0,o.save({bio:t}).catch((()=>{this.tempBio=t,this.tempSelector=r,this.edit()})).then((()=>{this.loading=!1,delete this.tempBio,m.redraw()}))),this.editing=!1,m.redraw()}reset(e){e.preventDefault(),this.isDirty()&&!confirm(B()(t().translator.trans("fof-user-bio.forum.profile.cancel_confirm")))||(this.editing=!1,delete this.tempBio,m.redraw())}isDirty(){const e=this.$("textarea").val();return this.attrs.user.bio()!==e}countTextLengthBefore(e){if(!e||e instanceof HTMLElement&&e.className.includes("UserBio"))return 0;let t=0;if(e.previousSibling)for(let o=e.previousSibling;o;o=o.previousSibling)t+=o.textContent.length;return e.parentNode,t+this.countTextLengthBefore(e.parentNode)}}flarum.reg.add("fof-user-bio","forum/components/UserBio",S);const w={UserBio:S};flarum.reg.add("fof-user-bio","forum/components",null),t().initializers.add("fof-user-bio",(()=>{l().prototype.bio=u().attribute("bio"),l().prototype.bioHtml=u().attribute("bioHtml"),(0,i.extend)(n().prototype,"infoItems",(function(e){let t=this.attrs.user;t.attribute("canViewBio")&&e.add("bio",m(S,{user:t,editable:this.attrs.editable}),-100)}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map